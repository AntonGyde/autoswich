
<!DOCTYPE html>
<html>
<head>
<style>
body{background:#111;color:#eee;font-family:sans-serif}
.mic{margin:10px;padding:10px;border:1px solid #333}
button{margin-top:6px}
.error{color:#f44;padding:10px;margin:10px;border:1px solid #f44}
.loading{color:#4af;padding:10px}
</style>
</head>
<body>
<h1>DM3 AutoCut v2.3.3</h1>
<div id="status" class="loading">Loading...</div>
<div id="mics"></div>

<script>
const mics=["host","g1","g2","g3"]
let errorCount = 0

async function poll(){
  try {
    const response = await fetch('/api/status')
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`)
    }
    const s = await response.json()
    
    // Clear error on successful fetch
    errorCount = 0
    document.getElementById('status').style.display = 'none'
    
    const root=document.getElementById('mics')
    root.innerHTML=''
    
    if(!s.calibration) {
      root.innerHTML = '<div class="loading">Waiting for calibration data...</div>'
      return
    }

    for(const id of mics){
      const r=s.calibration[id]
      root.innerHTML+=`
        <div class="mic">
          <b>${id}</b><br>
          ${r?JSON.stringify(r):'No data'}
          <br>
          <button onclick="cal('${id}')">Calibrate</button>
          <button onclick="apply('${id}')">Apply</button>
        </div>`
    }
  } catch (error) {
    console.error('Error fetching status:', error)
    errorCount++
    const statusDiv = document.getElementById('status')
    statusDiv.style.display = 'block'
    statusDiv.className = 'error'
    statusDiv.innerHTML = `Failed to fetch status (attempt ${errorCount}): ${error.message}<br>Retrying...`
  }
}

async function cal(id){
  try {
    const response = await fetch('/api/calibrate/'+id,{method:'POST'})
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`)
    }
    await response.json()
  } catch (error) {
    console.error('Error calibrating:', error)
    alert(`Failed to calibrate ${id}: ${error.message}`)
  }
}

async function apply(id){
  try {
    const response = await fetch('/api/apply/'+id,{method:'POST'})
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`)
    }
    await response.json()
  } catch (error) {
    console.error('Error applying calibration:', error)
    alert(`Failed to apply calibration for ${id}: ${error.message}`)
  }
}

setInterval(poll,500)
poll() // Initial call
</script>
</body>
</html>
